Audio = ->
  player = new Audio5js
    swf_path: '<%= Rails.public_path %>/audio5js.swf'
    throw_errors: true

  callbacks =
    onEnd: ->
    onPlay: ->

  player.on 'pause', -> callbacks.onEnd()
  player.on 'ended', -> callbacks.onEnd()
  player.on 'canplay', ->
    callbacks.onPlay()
    player.play()

  stop = ->
    player.pause()

  play = (opts) ->
    stop()
    player.load(opts.source)
    callbacks.onPlay = -> callbacks.onEnd = opts.onEnd

  stop: stop
  play: play

angular.module('pandify').factory('Audio', Audio)
